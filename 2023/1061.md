---
title: ä¸€ä¸ªå‘ROMå¯¼å…¥æœºå™¨ç çš„Pythonè„šæœ¬
mathjax: true
comments: false
---
<div class="post-info">
<span>ç¦».nvme0n1p2</span>
|
<abbr title="2023-10-27T23:11:35.620132+08:00"><time datetime="2023-10-27T23:11:35.620132+08:00">2023-10-27 23:11:35</time></abbr>
|
<span>â­ï¸ 1</span>
|
<span>ğŸ’¬ï¸ 2</span>
<br>
<div></div>
</div>

<div id="reply-4075" class="reply reply-l0">
<div class="reply-header">
<span>ç¦».nvme0n1p2</span>
</div>
<div class="reply-text">

# TL;DR(æˆ–è®¸ä¹Ÿæ²¡æœ‰é‚£ä¹ˆé•¿)
## é£Ÿç”¨æ–¹æ³•
- ä¸‹è½½Pythonè„šæœ¬`replace.py`
ï¼ˆæˆ–è€…ä¹Ÿè®¸ä½ æ„¿æ„ä»æ–‡æœ«å¤åˆ¶ï¼Ÿï¼‰
> https://bhpan.buaa.edu.cn/link/AA142FF068D230494AB6CF02281EEFE6FF<small>ï¼ˆæ— éœ€å­˜æ¡£ï¼‰</small>
Name: replace.py
Expires: 2023-11-26 21:59
Pickup Code: `0xdeadbeef`
- æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

``` shell
python replace.py <.circæ–‡ä»¶å> <æœºå™¨ç æ–‡æœ¬æ–‡ä»¶å>
```
å¤§åŠŸå‘Šæˆï¼ä¿®æ”¹åçš„.circæ–‡ä»¶å°†ä¿å­˜åœ¨å½“å‰ç›®å½•ä¸­ï¼Œæ–‡ä»¶åä¸ºåŸæ–‡ä»¶åååŠ ä¸Šå½“å‰çš„æ—¶é—´ï¼Œæ ¼å¼ä¸º`åŸæ–‡ä»¶å_æœºå™¨ç æ–‡æœ¬æ–‡ä»¶å_hhmmss.circ`

ä½¿ç”¨ä¾‹ï¼š
![image.png](/images/co-discussions/1061/image--1.png)
## å€¼å¾—æ³¨æ„çš„äº‹
### æ”¯æŒä»€ä¹ˆæœºå™¨ç æ–‡æœ¬æ–‡ä»¶ï¼Ÿ
1. `Mars`ä»¥`Hexadecimal Text`æ ¼å¼å¯¼å‡ºçš„æ–‡ä»¶
2. `Logisim`é€šè¿‡`ROM->Contents->Save`æ–¹å¼å¯¼å‡ºçš„æ–‡ä»¶
### æç¤º No match?
é‰´äºP3è¯¾ä¸‹çš„éœ€æ±‚ï¼Œæœ¬è„šæœ¬è®¾ç½®ä¸ºåŒ¹é…`Address Bit Width = 12`ä¸”`Data Bit Width=32`çš„ROMï¼Œå¦‚æœæœ‰å…¶ä»–éœ€æ±‚ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹`pattern`å˜é‡çš„ç›¸å…³å†…å®¹


# èƒŒæ™¯
å‘Logisimä¸­å¯¼å…¥å–è‡ªMarsçš„æœºå™¨ç æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹æ–‡æœ¬æ–‡ä»¶ï¼Œä¸”æ¶‰åŠå¤šæ¬¡é¼ æ ‡ç‚¹å‡»ã€‚é‰´äºç¬”è€…è¾ƒæ‡’ï¼Œé‚å°è¯•ç¼–å†™è„šæœ¬ä¸€åŠ³æ°¸é€¸åœ°è§£å†³é—®é¢˜ã€‚

# å‰æœŸå‡†å¤‡
çªçœ¼æ³•å‘ç°ï¼ŒLogisim ä»¥`.circ`æ–‡ä»¶æ ¼å¼ä¿å­˜ç”µè·¯ï¼Œè¿™äº›æ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯ XML æ–‡æ¡£ï¼Œå…è®¸ä»¥æ–‡æœ¬å½¢å¼è¿›è¡Œè¯»å–å’Œç¼–è¾‘,æ ·å¼å¦‚ä¸‹å›¾ï¼š

![image.png](/images/co-discussions/1061/image--2.png)

ä»¥æ–‡æœ¬æ ¼å¼æ‰“å¼€æŸå«æœ‰ROMç»„ä»¶çš„`.circ`æ–‡ä»¶ï¼Œæœç´¢`ROM`å…³é”®è¯å¾—ï¼š

![image.png](/images/co-discussions/1061/image--3.png)

æˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€ä¸ªï¼š

![image.png](/images/co-discussions/1061/image--4.png)

è¿™ä¸ªæ˜¾ç„¶ä¸æ˜¯ï¼Œç•¥è¿‡ï¼ˆé€ƒ

> åœ¨æ­¤éƒ¨åˆ†å®é™…ä¸Šå­˜å‚¨çš„æ˜¯ä»å·¦ä¾§å·¥å…·æ é€‰æ‹©ç»„ä»¶æ—¶çš„é»˜è®¤è®¾ç½®ã€‚ä½ å¯èƒ½æ³¨æ„åˆ°ï¼Œå½“ä»ä¾§è¾¹æ é€‰æ‹©ä¸€ä¸ªç»„ä»¶å¹¶åœ¨å°†å…¶æ”¾ç½®åˆ°ç”»å¸ƒä¸Šä¹‹å‰ä¿®æ”¹äº†å·¦ä¸‹è§’çš„ç»„ä»¶å±æ€§ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡é€‰æ‹©è¯¥ç»„ä»¶æ—¶ï¼Œå…¶é»˜è®¤å±æ€§å°±ä¼šå˜ä¸ºä¹‹å‰ä¿®æ”¹è¿‡çš„è®¾ç½®ï¼Œè¿™äº›è®¾ç½®é‡å¯Logisimåä»ä¼šä¿ç•™ã€‚è¿™äº›ä¸ªé»˜è®¤è®¾ç½®å°±å­˜å‚¨åœ¨è¿™é‡Œã€‚

å†çœ‹ç¬¬äºŒä¸ª:

![image.png](/images/co-discussions/1061/image--5.png)

ç›´è§‰å‘Šè¯‰æˆ‘ä»¬å®ƒå°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæˆ‘ä»¬è§‚å¯Ÿå®ƒçš„å‡ ä¸ªæ ‡ç­¾ï¼š
- `loc=(310ï¼Œ170)`å†³å®šäº†ç»„ä»¶åœ¨ç”»å¸ƒä¸Šçš„ä½ç½®ï¼Œé‰´äºæ¯ä¸ªäººçš„ç”»å¸ƒå¸ƒå±€ï¼ˆé€šå¸¸æ¥è¯´ï¼‰éƒ½ä¸åŒï¼Œè¿™éƒ¨åˆ†çš„å½±å“éœ€è¦æ’é™¤
- `addrWidth=12`å’Œ`dataWidth=32`è§„å®šäº†ç»„ä»¶çš„åœ°å€ä½å®½çš„æ•°æ®ä½å®½ï¼Œåœ¨P3ä¸­ï¼ŒROMçš„è¦æ±‚æ˜¯åœ°å€ä½å®½12ä½ï¼Œæ•°æ®ä½å®½32ä½
- `contents`æ˜¾ç„¶æˆ‘ä»¬æƒ³è¦æ›¿æ¢çš„æœºå™¨ç å°±ä¿å­˜åœ¨è¿™é‡Œ

# è„šæœ¬ç¼–å†™
## æ­£åˆ™è¡¨è¾¾å¼è®¾è®¡
``` RegEx
(<comp lib="4" loc="\([^"]+\)" name="ROM">\s*<a name="addrWidth" val="12"/>\s*<a name="dataWidth" val="32"/>\s*<a name="contents">addr/data: 12 32\s*)(.*?)(</a>\s*</comp>)
```
æ¯”OOPreçš„ä¸‰ä¸ªå¼å­ç®€å•å¤šäº†()

## Pythonç¨‹åºè®¾è®¡
ç•¥ï¼Œæ€»ä¹‹å°±æ˜¯è¯»å–-æŸ¥æ‰¾-æ›¿æ¢-è¾“å‡ºå››æ­¥èµ°

# æ”¹è¿›ç©ºé—´
æœ¬è„šæœ¬æœ‰å¾ˆå¤šæ”¹è¿›çš„æ–¹å‘ï¼Œç¬”è€…æœ¬äººå°±æƒ³åˆ°äº†ä¸¤ä¸ª
- å½“å‰è„šæœ¬ä½¿ç”¨çš„`re.search()`æ–¹æ³•åªè¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…ç»“æœï¼Œå¯¹äºP3çš„è¦æ±‚è¶³å¤Ÿï¼Œä½†æ˜¯å¯ä»¥æ”¹è¿›
- å¯ä»¥æ¥å—å¯é€‰çš„å¤šä¸ªè¾“å…¥ï¼Œå†³å®šåŒ¹é…ROMçš„`addrWidth`å’Œ`dataWidth`

# æºä»£ç 
> ï¼ˆæˆ–è€…ä¹Ÿè®¸ä½ æ„¿æ„ä»æ–‡æœ«å¤åˆ¶ï¼Ÿï¼‰
```python
import sys
import re
import datetime

def read_file(file_name):
    try:
        with open(file_name, 'r') as f:
            return f.readlines()
    except FileNotFoundError:
        print("File not found: " + file_name)
        exit(1)
    
def write_file(file_name, lines):
    try:
        with open(file_name, 'w') as f:
            f.writelines(lines)
    except FileNotFoundError:
        print("File not found: " + file_name)
        exit(1)

def main(circ_flie_path, hex_text_path):
    circ_data = read_file(circ_flie_path)
    hex_data = read_file(hex_text_path)

    new_hex_code = []
    start = False
    for line in hex_data:
        if line.strip() != 'v2.0 raw':
            start = True
        if start:
            new_hex_code.append(line)

    circ_content = "".join(circ_data)
    pattern = (
        r'(<comp lib="4" loc="\([^"]+\)" name="ROM">\s*'
        r'<a name="addrWidth" val="12"/>\s*'
        r'<a name="dataWidth" val="32"/>\s*'
        r'<a name="contents">addr/data: 12 32\s*)(.*?)(</a>\s*</comp>)'
    )
    match = re.search(pattern, circ_content, re.DOTALL)
    if match is None:
        print("No match")
        exit(1)
    
    result = []

    result.append(circ_content[:match.start()])
    result.append(match.group(1))
    result.append("".join(new_hex_code))
    result.append(match.group(3))
    result.append(circ_content[match.end():])

    result = "".join(result)

    circ_name = circ_flie_path.split('\\')[-1].split('.')[0]
    hex_name = hex_text_path.split('\\')[-1].split('.')[0]
    new_file_name =  circ_name + "_" + hex_name + "_" + datetime.datetime.now().strftime("%H%M%S") + ".circ"
    
    write_file(new_file_name, result)
    print('Replace success, new file: ' + new_file_name)


if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python replace.py <circ_file_path> <hex_text_path>")
        exit(1)
    main(sys.argv[1], sys.argv[2])
```



</div>
<div class="reply-footer">
<abbr title="2023-10-27T23:11:35.626538+08:00"><time datetime="2023-10-27T23:11:35.626538+08:00">2023-10-27 23:11:35</time></abbr>
|
<span>CC BY-SA 4.0ï¼ˆä»£ç  MITï¼‰</span>
<span class="reply-vote">â¤ï¸ 1</span>
</div>
</div>
<hr class="reply-separator">
<div id="reply-4095" class="reply reply-l1">
<div class="reply-header">
<span>æ½œä¼ <a href="#reply-4075">å›å¤</a> ç¦».nvme0n1p2</span>
</div>
<div class="reply-text">

å¯ä»¥ä½¿ç”¨`re.sub()`ä¸€é”®å®ç°æ­£åˆ™åŒ¹é…æ›¿æ¢

</div>
<div class="reply-footer">
<abbr title="2023-10-29T18:46:13.758725+08:00"><time datetime="2023-10-29T18:46:13.758725+08:00">2023-10-29 18:46:13</time></abbr>
|
<span>CC BY-NC-SA 4.0</span>
<span class="reply-vote">â¤ï¸ 0</span>
</div>
</div>