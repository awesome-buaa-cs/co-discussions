---
title: P3-CPUè‡ªåŠ¨åŒ–æµ‹è¯•
mathjax: true
comments: false
---
<div class="post-info">
<span>Shae</span>
|
<abbr title="2023-10-31T14:41:00.749452+08:00"><time datetime="2023-10-31T14:41:00.749452+08:00">2023-10-31 14:41:00</time></abbr>
|
<span>â­ï¸ 1</span>
|
<span>ğŸ’¬ï¸ 2</span>
<br>
<div><div class="post-tag">P3</div></div>
</div>

<div id="reply-4106" class="reply reply-l0">
<div class="reply-header">
<span>Shae</span>
<div class="reply-verified">åŠ©æ•™è®¤è¯</div>
</div>
<div class="reply-text">

# P3-CPUè‡ªåŠ¨åŒ–æµ‹è¯•

> æœ¬æ–‡ä¸»è¦å®ç°äº†æ ·ä¾‹è‡ªåŠ¨ç”Ÿæˆçš„ç¨‹åºå¹¶æ•´ç†äº†Pythonä¸€é”®å¯¹æ‹çš„å¿…è¦æ­¥éª¤ã€‚åœ¨æ ·ä¾‹è‡ªåŠ¨ç”Ÿæˆæ–¹é¢ï¼Œå°½å¯èƒ½åœ°æ‰©å¤§è¦†ç›–èŒƒå›´å¹¶æ¶ˆé™¤æ­»å¾ªç¯çš„é£é™©ã€‚è‹¥æœ‰å»ºè®®ï¼Œè¯·ä¸åèµæ•™~~

## 1.æ ·ä¾‹

### 1.1.è¦†ç›–èŒƒå›´

#### 1.1.1.æŒ‡ä»¤

* `add`,`sub`
  * æ³¨æ„ï¼šæŒ‰**æ— ç¬¦å·**åŠ å‡æ³•å¤„ç†ã€‚å› æ­¤è‹¥ç”¨æ ·ä¾‹è·‘MARSä¼šå‡ºç°`Arithmetic Overflow`çš„æŠ¥é”™æç¤ºã€‚
* `ori`, `lw`, `sw`,`lui`,`beq`
* `jal`

#### 1.1.2.å–å€¼

ä»»ä¸€æ ·ä¾‹ä¸­å‡ºç°è¾¹ç•Œå€¼çš„æ¦‚ç‡æ¥è¿‘ç™¾åˆ†ç™¾ã€‚

* å¯„å­˜å™¨
  * 0é™„è¿‘
  * 32ä½æ•°è¾¹ç•Œé™„è¿‘
  * 32ä½æ•°èŒƒå›´å†…çš„éšæœºæ•°ï¼ˆä¸ºä¿è¯lwå’Œswè¿‡ç¨‹æ—¶åœ°å€ä¸è¶…è¿‡ROMå’ŒRAMçš„èŒƒå›´ï¼Œæ•…è®¾ç½®å¾—è¾ƒå°ï¼‰
* æ— ç¬¦å·16ä½ç«‹å³æ•°ï¼ˆ`ori`,`lui`ï¼‰
  * 0é™„è¿‘
  * 16ä½æ— ç¬¦å·æ•°è¾¹ç•Œé™„è¿‘
  * éšæœºæ•°

#### 1.1.3.è·³è½¬æ–¹å‘

* å‘åè·³

* å‘å‰è·³

  beqä¸å‚ä¸å…¶ä»–æŒ‡ä»¤çš„éšæœºç”Ÿæˆç¨‹åºï¼Œè‡ªæˆä¸€ä¸ªæ¨¡å—ï¼Œä»¥ç‰¹å®šçš„é¢‘ç‡ç©¿æ’åœ¨ä»£ç ä¸­ã€‚

  è®¾ç½®ç‹¬ç«‹çš„è·³è½¬åŒºï¼Œé¿å…æ­»å¾ªç¯ã€‚

  ![P3è‡ªåŠ¨æµ‹è¯•ç”Ÿæˆå™¨beqå‘å‰è·³.jpg](/images/co-discussions/1070/P3è‡ªåŠ¨æµ‹è¯•ç”Ÿæˆå™¨-beqå‘å‰è·³.jpg)

### 1.2.ä»£ç ç»“æ„

0. è¾“å‡ºé‡å®šå‘
1. æŒ‡ä»¤å‡½æ•°
2. éšæœºæŒ‡ä»¤åŒ¹é…
3. ä¸»é€»è¾‘
   * æç«¯å€¼æµ‹è¯•
   * è·³è½¬æµ‹è¯•

### 1.3.æºä»£ç 

```python
import random
import sys
extremeImmu16 = [0, 1, 2, 3, 65533, 65534, 65535]
sizeEIu16 = 6 
def extremeRegu32(r):
    lui(r,65535)
    ori(r,r,extremeImmu16[random.randint(0,sizeEIu16)])
    return 

#0.open test.asm
sys.stdout = open("D:\BUAA\practice\logism\cpu_test\\test.asm", "w")

#1.instruction
def add(rd, rs, rt):
    print("add $"+str(rd)+",$"+str(rs)+",$"+str(rt))
    return
def sub(rd, rs, rt):
    print("sub $"+str(rd)+",$"+str(rs)+",$"+str(rt))
    return
def ori(rt, rs, imm):
    print("ori $"+str(rt)+",$"+str(rs)+","+str(imm))
    return
def lw(rt, base):
    ori(base, 0, random.randint(1,6) * 4)
    offset = random.randint(0,40) * 4
    print("lw $"+str(rt)+","+str(offset)+"($"+str(base)+")")
    return
def sw(base, rt):
    ori(base, 0, random.randint(1,6) * 4)
    offset = random.randint(0,40) * 4
    print("sw $"+str(rt)+","+str(offset)+"($"+str(base)+")")
    return
def lui(rt, imm):
    print("lui $"+str(rt)+","+str(imm))
    return

#2.generate instruction
def generate(op, rs, rt, rd):
    match op:
        case 0:
            print("nop")    
        case 1:
            sub(rd, rs, rt)
        case 2:
            imm = random.randint(0, 200)
            ori(rt, rs, imm)
        case 3:
            lw(rt, rs)
        case 4:
            sw(rs, rt)        
        case 5:
            imm = random.randint(0, 200)
            lui(rt, imm)  
        case 6:
            add(rd, rs, rt)
        case _:
            return    
    return

#3.main logic
for index in range(0,31):
    imm = random.randint(3, 12)
    ori(index, 0, imm)

for i in range(0, 200):
    rs = random.randint(0,31)
    rt = random.randint(0,31)
    rd = random.randint(0,31)
    op = random.randint(0,6)  
    isExtreme = random.randint(0,1)
    
    if op == 2:
        if isExtreme == 0:
            generate(op, rs, rt, rd)
        else:
            extremeRegu32(rt)
            extremeRegu32(rs)
            ori(rt, rs, extremeImmu16[random.randint(0,sizeEIu16)])
            ori(rt, 0, random.randint(3, 12))
            ori(rs, 0, random.randint(3, 12))
    elif op == 1 or op == 6:
        if isExtreme == 0:
            generate(op, rs, rt, rd)
        else:
            extremeRegu32(rs)
            extremeRegu32(rt)
            extremeRegu32(rd)
            generate(op, rs, rt, rd)
            ori(rs, 0, random.randint(3, 12))
            ori(rt, 0, random.randint(3, 12))
            ori(rd, 0, random.randint(3, 12))
    elif op == 5:
        if isExtreme == 0:
            generate(op, rs, rt, rd)
        else:
            extremeRegu32(rt)
            lui(rt, extremeImmu16[random.randint(0,sizeEIu16)])
            ori(rt, 0, random.randint(3, 12))
    else:
        generate(op, rs, rt, rd)   

    if i % 30 == 0:
        index = int(i / 30)
        if index < 3:
            if index != 0:
                jumpZoneIndex = int(index - 1)
                rt = random.randint(0,31)
                rs = random.randint(0,31)
                print("beq $"+str(rt)+",$"+str(rs)+","+"JumpZone"+str(jumpZoneIndex))
                print("nop")
                print("JumpOut"+str(jumpZoneIndex)+":")  
            print("jal Text"+str(index))
            print("nop")
            print("JumpZone"+str(index)+":")
            generate(op, rs, rt, rd)
            print("jal JumpOut"+str(index))
            print("nop")
            print("Text"+str(index)+":")
        else:
            if index == 3:
                jumpZoneIndex = int(index - 1)
                rt = random.randint(0,31)
                rs = random.randint(0,31)
                print("beq $"+str(rt)+",$"+str(rs)+","+"JumpZone"+str(jumpZoneIndex))
                print("nop")
                print("JumpOut"+str(jumpZoneIndex)+":")  
            
            randomJump = random.randint(index,index+1) if index < 6 else index
            rt = random.randint(0,31)
            rs = random.randint(0,31)
            print("beq $"+str(rt)+",$"+str(rs)+","+"JumpOut"+str(randomJump))   
            print("nop")
            print("JumpOut"+str(index)+":")  


```

## 2.å¯¹æ‹

> å‚è€ƒäº†ç½‘ä¸Šèµ„æ–™ï¼Œæ•´ç†è€Œå¾—

### 2.1.Pythonè°ƒç”¨ç³»ç»Ÿå‘½ä»¤

* `os.system(cmd)`ï¼šå°†å­—ç¬¦ä¸²è½¬åŒ–æˆå‘½ä»¤è¡Œåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œä»…åœ¨ä¸€ä¸ªå­ç»ˆç«¯è¿è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œè€Œä¸è·å–å‘½ä»¤æ‰§è¡Œåçš„è¿”å›ä¿¡æ¯ã€‚
* `os.popen(cmd)`ï¼šä¸ä»…æ‰§è¡Œå‘½ä»¤è€Œä¸”è¿”å›æ‰§è¡Œåçš„ä¿¡æ¯å¯¹è±¡ï¼Œé€šè¿‡ç®¡é“æ–‡ä»¶å°†ç»“æœè¿”å›ã€‚å¯ä»¥ä½¿ç”¨read()æ“ä½œçœ‹åˆ°æ‰§è¡Œçš„è¾“å‡ºã€‚

### 2.2.Logisimè‡ªåŠ¨åŒ–æµ‹è¯•

#### 2.2.1.å‘½ä»¤è¡Œ

```
java -jar logisim-generic-2.7.1.jar myCpu_m.circ -tty table > cpuRes.txt
```

* è·¯å¾„ï¼š

  * å‘½ä»¤è¡Œï¼šè‹¥è¾“å‡ºæ–‡ä»¶æ²¡æœ‰å†™æ˜è·¯å¾„ï¼Œä¼šå­˜åœ¨å‘½ä»¤è¡Œå¼€å¤´çš„åœ°å€ä¸­ã€‚
  * ç¨‹åºï¼šè‹¥è¾“å‡ºæ–‡ä»¶æ²¡æœ‰å†™æ˜è·¯å¾„ï¼Œä¼šå­˜åœ¨ç¨‹åºæ‰€åœ¨æ–‡ä»¶å¤¹ä¸­ã€‚

* å¦‚æœå°†commandå†™è¿›pythonæ–‡ä»¶ï¼Œç›®æ ‡æ–‡ä»¶å‰é¢åº”æœ‰**åŒ**åæ–œæ 

  ```python
  command = "java -jar logisim-generic-2.7.1.jar myCpu.circ -tty table > address\\cpuRes.txt"
  ```


#### 2.2.2.CPUæµ‹è¯•è®¾ç½®

è®¾ç½®haltï¼Œä½¿ç¨‹åºè‡ªåŠ¨åœæ­¢ã€‚

* å®˜æ–¹æ–‡æ¡£ï¼š
  ![Logisim_halt.jpg](/images/co-discussions/1070/Logisim_halt.jpg)
* å®ç°ï¼šç¬¬ä¸€è®¡æ•°å™¨çš„å€¼æ˜¯çµæ´»å¯å˜çš„ã€‚ä¸¤ä¸ªè®¡æ•°å™¨éƒ½åº”è®¾ç½®ä¸º**Stay At Value**

  ![halt_setting.jpg](/images/co-discussions/1070/halt_setting.jpg)



### 2.3.Marså‘½ä»¤è¡Œå¯¼å‡ºæœºå™¨ç 

```
java -jar Mars4_5.jar test.asm nc mc CompactTextAtZero a dump .text HexText hexTextCode.txt
```



### 2.4.æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…

æ˜¾è€Œæ˜“è§ï¼ŒROMæ•°æ®ä»`<a name="contents">addr/data: 12 32`å¼€å§‹ï¼Œåªéœ€åœ¨æ­¤å¤„å°†æœºå™¨ç å¯¼å…¥å³å¯ã€‚

![P3è‡ªåŠ¨åŒ–æµ‹è¯•æ­£åˆ™.jpg](/images/co-discussions/1070/P3-è‡ªåŠ¨åŒ–æµ‹è¯•-æ­£åˆ™.jpg)

## 3.é›†æˆ

åˆ©ç”¨Pythonçš„ç³»ç»Ÿè°ƒç”¨å‘½ä»¤ï¼Œå®ç°ä¸€é”®æ ·ä¾‹å¯¹æ‹ã€‚

## 4.è‡´è°¢

æˆ‘çš„å·¥ä½œä¸»è¦é›†ä¸­åœ¨æ ·ä¾‹ç”Ÿæˆéƒ¨åˆ†ï¼Œ**æ„Ÿè°¢åŠ©æ•™é©¬ç‘€é˜”å­¦é•¿çš„æŒ‡ç‚¹**âœ§\*ï½¡ (ËŠá—œË‹\*) âœ§\*ï½¡

updateï¼šæ„Ÿè°¢æ¨è£æ´¥åŒå­¦çš„æé†’ã€‚å·²å¯¹ä»£ç ä¸­è¾¹ç•Œå€¼éƒ¨åˆ†åšå‡ºä¿®æ”¹ã€‚

</div>
<div class="reply-footer">
<abbr title="2023-10-31T14:41:00.763833+08:00"><time datetime="2023-10-31T14:41:00.763833+08:00">2023-10-31 14:41:00</time></abbr>
|
<span>ä¿ç•™æ‰€æœ‰æƒåˆ©ï¼ˆä»£ç  MITï¼‰</span>
<span class="reply-vote">â¤ï¸ 8</span>
</div>
</div>
<hr class="reply-separator">
<div id="reply-4107" class="reply reply-l1">
<div class="reply-header">
<span>ScottMaï¼ˆåŠ©æ•™ï¼‰ <a href="#reply-4106">å›å¤</a> Shae</span>
</div>
<div class="reply-text">

å¾ˆä¼˜ç§€çš„å°è¯•ï¼ŒåŒå­¦ä»¬å¯ä»¥å°è¯•å€ŸåŠ©æ—åŒå­¦å¯¹å¯¹æ‹éƒ¨åˆ†çš„æ€è·¯æç¤ºè‡ªè¡Œç¼–å†™è„šæœ¬ï¼Œå®ç°è¯„æµ‹çš„è‡ªåŠ¨åŒ–

</div>
<div class="reply-footer">
<abbr title="2023-10-31T15:10:55.446392+08:00"><time datetime="2023-10-31T15:10:55.446392+08:00">2023-10-31 15:10:55</time></abbr>
|
<span>CC BY-ND 4.0</span>
<span class="reply-vote">â¤ï¸ 0</span>
</div>
</div>