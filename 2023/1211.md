---
title: å…³äºp7ä¸­æ–­æµ‹è¯•åˆ†äº«
mathjax: true
comments: false
---
<div class="post-info">
<span>Carbon</span>
|
<abbr title="2023-12-15T14:40:05.812725+08:00"><time datetime="2023-12-15T14:40:05.812725+08:00">2023-12-15 14:40:05</time></abbr>
|
<span>â­ï¸ 1</span>
|
<span>ğŸ’¬ï¸ 1</span>
<br>
<div></div>
</div>

<div id="reply-4873" class="reply reply-l0">
<div class="reply-header">
<span>Carbon</span>
</div>
<div class="reply-text">

## æ„æƒ³çš„ä¸­æ–­å‘ç”Ÿæƒ…å†µ

+ å¸¸è§„æŒ‡ä»¤ï¼šé˜»å¡ä¸€å‘¨æœŸã€é˜»å¡ä¸¤å‘¨æœŸ
+ sw
+ è·³è½¬å»¶è¿Ÿæ§½ï¼šè·³è½¬ã€æœªè·³è½¬
+ eretåä¸€æ¡æŒ‡ä»¤
+ ä¹˜é™¤æŒ‡ä»¤
+ ä¹˜é™¤æ§½
+ ä¹˜é™¤æ§½å†…çš„å»¶è¿Ÿæ§½
+ æŒ‡ä»¤å¼‚å¸¸
+ æŒ‡ä»¤å¼‚å¸¸ä¸”å¤„äºå»¶è¿Ÿæ§½

## å¯¹åº”`.asm`

æ³¨ï¼šä»¥ä¸‹æµ‹è¯•ä»£ç ä»…é’ˆå¯¹æœ¬äººç»“æ„ç¼–å†™ï¼Œå³ä¹˜é™¤æ¨¡å—åœ¨Eçº§ï¼Œcp0åœ¨Mçº§ã€‚ä¾‹å¦‚ä¸ºäº†æµ‹ä¹˜é™¤æŒ‡ä»¤åˆšåˆ°ä¹˜é™¤æ¨¡å—æ—¶çš„æƒ…å†µï¼ŒmacroPCå–ä¹˜é™¤æŒ‡ä»¤ä¸Šä¸€æ¡ã€‚ç„¶è€Œï¼Œå¦‚æœä½ é‡‡ç”¨äº†å…¶ä»–çš„è®¾è®¡ï¼Œè¿˜è¯·è‡ªè¡Œè°ƒæ•´ã€‚

æ­¤ä»£ç æœªæµ‹è¯•ä¸­æ–­å‘ç”Ÿåœ¨eretåçš„æƒ…å†µï¼Œç„¶è€Œå¼ºçƒˆå»ºè®®è‡ªè¡Œè¿›è¡Œæµ‹è¯•

ç”±äºæ°´å¹³æœ‰é™ï¼Œ**ä¸ä¿è¯å¯¹åº”æµ‹è¯•ä»£ç çœŸçš„èµ·åˆ°æµ‹è¯•çš„ä½œç”¨**ï¼Œè¿˜è¯·å„ä½å¤§ä½¬æ‰¹è¯„æŒ‡æ­£

```
no_jump:
ori $28, $28, 4
ori $29, $29, 1

ori $20, $0, 0x1001
mtc0 $20, $12

ori $1, $1, 246
ori $2, $2, 135
beq $2, $zero, no_jump
nop

sw $28, 0($zero)

lw $3, 0($zero)
beq $3, $zero, no_jump
nop

beq $zero, $zero, jump1
add $4, $4, $29
add $5, $5, $29
jump1:
beq $zero, $29, jump2
add $4, $4, $29
add $5, $5, $29
jump2:

mult $1, $2
add $6, $29, $10
mflo $7

mult $1, $2
add $6, $29, $10
add $6, $29, $10
mflo $7

mult $7, $1
beq $zero, $29, jump3
mflo $7
jump3:
add $6, $29, $10

lw $8, 1($0)

beq $zero, $29, no_jump
lw $8, 1($0)
add $6, $29, $10

.ktext 0x4180
mfc0 $26, $13
ori $21, $21, 0x7c
and $26, $21, $26
beq $26, $zero, interruption
nop
# å¯¹äºå¼‚å¸¸ç¨‹åºç›´æ¥å¿½è§†ï¼ˆæœªè€ƒè™‘pcå¼‚å¸¸ï¼‰
exception:
mfc0 $27, $14
add $27, $27, $28
mtc0 $27, $14
eret
# å¯¹äºä¸­æ–­è®©30å·å¯„å­˜å™¨åŠ ä¸€
interruption:
add $30, $30, $29
sw $30, 0x7F20($zero)
eret
add $30, $30, $28 #eretæ— å»¶è¿Ÿæ§½
```

## æ•°æ®å¯¼å‡ºæ–¹æ¡ˆ

åœ¨Marsæ‰€åœ¨åœ°å€æ‰“å¼€cmdè¾“å…¥

```
java -jar <mars> db nc mc CompactDataAtZero a dump 0x4180-0x6ffc HexText <xxx.txt> <xxx.asm>
```

## ä¿®æ”¹åçš„tb

```verilog
`timescale 1ns/1ps

module mips_txt;

	reg clk;
	reg reset;
	reg interrupt;

	wire [31:0] macroscopic_pc;

	wire [31:0] i_inst_addr;
	wire [31:0] i_inst_rdata;

	wire [31:0] m_data_addr;
	wire [31:0] m_data_rdata;
	wire [31:0] m_data_wdata;
	wire [3 :0] m_data_byteen;

	wire [31:0] m_int_addr;
	wire [3 :0] m_int_byteen;

	wire [31:0] m_inst_addr;

	wire		w_grf_we;
	wire [4 :0] w_grf_addr;
	wire [31:0] w_grf_wdata;

	wire [31:0] w_inst_addr;

	mips uut(
		.clk(clk),
		.reset(reset),
		.interrupt(interrupt),
		.macroscopic_pc(macroscopic_pc),

		.i_inst_addr(i_inst_addr),
		.i_inst_rdata(i_inst_rdata),

		.m_data_addr(m_data_addr),
		.m_data_rdata(m_data_rdata),
		.m_data_wdata(m_data_wdata),
		.m_data_byteen(m_data_byteen),

		.m_int_addr(m_int_addr),
		.m_int_byteen(m_int_byteen),

		.m_inst_addr(m_inst_addr),

		.w_grf_we(w_grf_we),
		.w_grf_addr(w_grf_addr),
		.w_grf_wdata(w_grf_wdata),

		.w_inst_addr(w_inst_addr)
	);

	initial begin
		clk <= 0;
		reset <= 1;
		interrupt <= 0;
		#20 reset <= 0;
	end

	integer i;
	reg [31:0] fixed_addr;
	reg [31:0] fixed_wdata;
	reg [31:0] data[0:4095];
	reg [31:0] inst[0:5119];

	// ----------- For Instructions -----------

	assign m_data_rdata = data[(m_data_addr >> 2) % 5120];
	assign i_inst_rdata = inst[((i_inst_addr - 32'h3000) >> 2) % 5120];

	initial begin
	$dumpfile("wave.vcd");  // æŒ‡å®šVCDæ–‡ä»¶çš„åå­—ä¸ºwave.vcdï¼Œä»¿çœŸä¿¡æ¯å°†è®°å½•åˆ°æ­¤æ–‡ä»¶
	$dumpvars(0, mips_txt);  // æŒ‡å®šå±‚æ¬¡æ•°ä¸º0ï¼Œåˆ™tb_code æ¨¡å—åŠå…¶ä¸‹é¢å„å±‚æ¬¡çš„æ‰€æœ‰ä¿¡å·å°†è¢«è®°å½•
    #20000 $finish;
    end
	
	initial begin
		$readmemh("code.txt", inst);
		$readmemh("handlerCode.txt", inst, (32'h4180-32'h3000)>>2);
		for (i = 0; i < 5120; i = i + 1) data[i] <= 0;
	end

	// ----------- For Data Memory -----------

	always @(*) begin
		fixed_wdata = data[(m_data_addr >> 2) & 4095];
		fixed_addr = m_data_addr & 32'hfffffffc;
		if (m_data_byteen[3]) fixed_wdata[31:24] = m_data_wdata[31:24];
		if (m_data_byteen[2]) fixed_wdata[23:16] = m_data_wdata[23:16];
		if (m_data_byteen[1]) fixed_wdata[15: 8] = m_data_wdata[15: 8];
		if (m_data_byteen[0]) fixed_wdata[7 : 0] = m_data_wdata[7 : 0];
	end

	always @(posedge clk) begin
		if (reset) for (i = 0; i < 4096; i = i + 1) data[i] <= 0;
		else if (|m_data_byteen && fixed_addr >> 2 < 4096) begin
			data[fixed_addr >> 2] <= fixed_wdata;
			$display("%d@%h: *%h <= %h", $time, m_inst_addr, fixed_addr, fixed_wdata);
		end
	end

	// ----------- For Registers -----------

	always @(posedge clk) begin
		if (~reset) begin
			if (w_grf_we && (w_grf_addr != 0)) begin
				$display("%d@%h: $%d <= %h", $time, w_inst_addr, w_grf_addr, w_grf_wdata);
			end
		end
	end

	// ----------- For Interrupt -----------

	wire [31:0] fixed_macroscopic_pc;

	assign fixed_macroscopic_pc = macroscopic_pc & 32'hfffffffc;

	integer cnt;

	always @(negedge clk) begin
		if (reset) begin
			interrupt = 0;
			cnt = 0;
		end
		else begin
			if (interrupt) begin
				if (|m_int_byteen && (m_int_addr & 32'hfffffffc) == 32'h7f20) begin
					interrupt = 0;
				end
			end
			//é˜»å¡ä¸€ä¸ªå‘¨æœŸ
			else if (fixed_macroscopic_pc == 32'h3014 && cnt == 0) begin
				interrupt = 1;
				cnt = cnt + 1;
			end
			//swåŒæ—¶ä¸­æ–­ï¼ˆéœ€åœæ­¢å†™å…¥ï¼‰
			else if (fixed_macroscopic_pc == 32'h3020 && cnt == 1) begin
				interrupt = 1;
				cnt = cnt + 1;
			end
			//é˜»å¡ä¸¤ä¸ªå‘¨æœŸ
			else if (fixed_macroscopic_pc == 32'h3028 && cnt == 2) begin
				interrupt = 1;
				cnt = cnt + 1;
			end
			//å»¶è¿Ÿæ§½
			else if (fixed_macroscopic_pc == 32'h3034 && cnt == 3) begin
				interrupt = 1;
				cnt = cnt + 1;
			end
			else if (fixed_macroscopic_pc == 32'h3040 && cnt == 4) begin
				interrupt = 1;
				cnt = cnt + 1;
			end
			//ä¹˜é™¤æŒ‡ä»¤
			else if (fixed_macroscopic_pc == 32'h3044 && cnt == 5) begin
				interrupt = 1;
				cnt = cnt + 1;
			end
			else if (fixed_macroscopic_pc == 32'h3060 && cnt == 6) begin
				interrupt = 1;
				cnt = cnt + 1;
			end
			else if (fixed_macroscopic_pc == 32'h306c && cnt == 7) begin
				interrupt = 1;
				cnt = cnt + 1;
			end
			//æŒ‡ä»¤å¼‚å¸¸
			else if (fixed_macroscopic_pc == 32'h3074 && cnt == 8) begin
				interrupt = 1;
				cnt = cnt + 1;
			end
			else if (fixed_macroscopic_pc == 32'h307c && cnt == 9) begin
				interrupt = 1;
				cnt = cnt + 1;
			end
		end
	end

	always #2 clk <= ~clk;

endmodule
```

## å¯¹åº”æ˜“é”™ç‚¹

+ è·³è½¬æŒ‡ä»¤æ— è®ºæ˜¯å¦è·³è½¬ï¼Œæ¥ä¸‹æ¥ä¸€æ¡æŒ‡ä»¤éƒ½åº”è§†ä¸ºå»¶è¿Ÿæ§½
+ cp0è®¾è®¡åœ¨wçº§åˆ™éœ€è¦æ£€æŸ¥`store`ç±»æŒ‡ä»¤åœ¨wæ—¶è¢«ä¸‹ä¸­æ–­å†™ä½¿èƒ½ä¿¡å·æ˜¯å¦å…³é—­
+ å¦‚æœè®¾è®¡eretåæ¸…ç©ºå»¶è¿Ÿæ§½åˆ™éœ€è¦è€ƒè™‘ä¼˜å…ˆçº§é—®é¢˜ï¼ˆé˜»å¡>æ¸…ç©ºï¼‰
+ æ›´è¿›ä¸€æ­¥ï¼Œå¦‚æœè®¾è®¡äº†æ¸…ç©ºå»¶è¿Ÿæ§½éœ€è¦è€ƒè™‘**åœ¨`eret`åçš„`nop`ä¸‹ä¸­æ–­**çš„æƒ…å†µ

</div>
<div class="reply-footer">
<abbr title="2023-12-15T14:40:05.830232+08:00"><time datetime="2023-12-15T14:40:05.830232+08:00">2023-12-15 14:40:05</time></abbr>
|
<span>CC BY 4.0</span>
<span class="reply-vote">â¤ï¸ 6</span>
</div>
</div>