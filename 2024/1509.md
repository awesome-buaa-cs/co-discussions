---
title: 编写verilog的优秀实践/码风总结
layout: default
parent: 2024 年
nav_order: 1509
---
# 编写verilog的优秀实践/码风总结
<div class="post-info">
<span>向滢澔</span>
|
<abbr title="2024-11-08T09:16:12.79555+08:00"><time datetime="2024-11-08T09:16:12.79555+08:00">2024-11-08 09:16:12</time></abbr>
|
<span>⭐️ 10</span>
|
<span>💬️ 1</span>
<br>
<div><div class="post-tag">分享</div><div class="post-tag">Verilog</div></div>
</div>

<div id="reply-5856" class="reply reply-l0">
<div class="reply-header">
<span>向滢澔</span>
</div>
<div class="reply-text">

# 前言
> 🤓👆最近给好朋友debug的时候发现他代码经常出现语法性和wire接错位置错误，而且全得靠火眼金睛去找，特别痛苦，为了避免大家也出现verilog报错一大堆的情况，故写下此文。

还有一点：如果有好意见可以告诉我，我还会时不时更新一下这里这些建议。

## 1. 编写习惯

### 1-1. 完善草稿后编写
对于P4之后的CPU来说，草稿确实是不可或缺的一份，一个优秀的草稿不止可以让你在写代码的时候更加顺利，在debug和上机考试的时候也能让你更加得心应手。

一份好的草稿个人认为除了标记控制信号与连线方法的excel文档，还应该有一份设计的简图，包含你的cpu的大概的样子，以P5为例，我本人的草稿大概是这样的：
![IMG_2522.jpeg](/assets/cscore-image/22375354/704c97eb-8b89-4bb2-866f-7bcbf60fed94/IMG_2522.jpeg)

当然草稿的方式很多样，你大可不必画的过于详细，这里也推荐几种草稿的方法：
- 控制信号与接线
	- 利用excel构建控制信号的表
	- markdown的表格也比较清晰
	- 纯手写也可以，但是上机可能会比较难添加
- CPU架构草稿
	- logisim其实是很好的草稿本，只关心模块外观，内部实现留空即可
	- draw.io也是，在线绘图
	- 我用过一个叫axglyph的国产软件，也算好用
	- 纯手绘（procreate、无边记、ps），个人比较倾向这个，追求完美的可以考虑

### 1-2. 不要轻易开始代码

对于verilog这个行为级别的语言，虽然看起来和c语言差不多，但是要注意的就是一定不能纯用c语言的思想来进行verilog语言的编写，如果贸然开始只会导致你陷入无尽的代码重构与debug的痛苦深渊。

草稿打完之后可以再对照你写的控制信号列表核对一次信息是不是正确往后流转，这也是流水线最难debug的一个地方。

一定要注意：**千万不要不打草稿直接开写**，这样很容易导致难以发现的bug，导致你debug花费更多精力，干别的事情的时候还在想`jal`。~~此处忽略一条6系圣经~~

### 1-3. 不要过度准备课上

我曾经也犯过这个问题，在P4课下阶段出于对自己设计的不自信以及对于上机内容的未知，提前设计了超出设计范围的更多指令，虽然看起来是"准备更加充分"，但是我发现也产生了不小的问题：
- 控制信号冲突
- 实现复杂，可能造成不同指令的耦合
- 增添的指令存在错误影响其他指令

总之，对于提交的最后一版，我建议只保留上机所需的最基本指令，这样无论是对于现场debug还是增加指令都可以更加方便。

### 1-4. 进行较为充分的本地测试

有一部分人（包括我自己在内）对于麻烦的测试十分苦恼，于是喜欢直接提交到oj平台看报什么错误，虽然看起来更加方便，但是平台只会告诉你第一次出错的地方，你不会知道出错之前经历了什么，便会导致你debug的时候连哪里出问题都不知道。

进行本地测试有很多种方法，其一就是手动编写MIPS然后导出机器码给verilog来对比，但是我更建议的是利用同学发布的自动评测机来进行这个过程，评论区也有很多构造数据的方法，都是可以接受的，多看评论区也是很好的习惯。

## 2. 代码风格

### 2-1. 接口定义

建议在开头加上一行定义：
```verilog
`default_nettype none
```

显式提供你的接口是`reg`还是`wire`其实很重要，默认来说不提供类型的接口都是`wire`型，但是可能会导致你在内部直接对输出错误驱动的问题，并且"不是很聪明"的ISE的语法检测器也不会给你报错，这样会导致你的bug就非常的难找。

### 2-2. 模块内变量定义位置

之前debug的时候发现舍友的变量分散定义在不同地方，名字还对对错错的，很是恼火，因此我建议全部按照位宽整理好，放在模块内部最上方：
```verilog
module example(
// some interface
);
wire [31:0] a, b, c;
wire [4:0] a1, a2, a3;
reg reg_1, reg_2;
// specific code
endmodule
```
特别是对于顶层模块的接线，由于十分复杂，一定要养成良好习惯，不要乱七八糟放在各个地方。

### 2-3. 变量命名

这一点课程组也多次提到过，重要性更是不言而喻，一个好的变量命名应该尽量使用有意义的单词，我在这里给一个命名的例子，当然其他名字也是可以接受的，我只是抛砖引玉一下：

```verilog
wire modulename_jointname_level
// 分别是模块名字，连接模块的那个接口的名字，所在流水线的级别
```

当然大小写也很重要，分清楚大小写是很好的习惯，verilog是大小写敏感的。

### 2-4. 缩短一行长度

在verilog里面许多语句都会导致超级长的一行，但是又由于verilog是空白字符不敏感的（反例：python），是利用分号表示一个语句的结束，因此你可以放心大胆地在一些地方给语句分行，特别建议分行的语句包括模块的示例化、三元运算符`?:`，如下：

```verilog
ALU alu_inst(	.A(rf_rd1_e),
				.B(rf_rd2_e),
				.C(alu_c_e),
				.ALUOp(ctrl_aluop_e));
// ...
assign data_in_d = (Op == 2'b00) ? data1 :
				   (Op == 2'b01) ? data2 :
				   (Op == 2'b10) ? data3 : data4;
// ...
```

### 2-5. 不要在示例化模块的接口部分使用系统函数

这个其实不算一个码风建议，但是由于ISE的语法分析器确实有bug，导致如下语句会触发某个cpp文件的fatal
error：

```verilog
ALU alu_inst(	.A(rf_rd1_e),
				.B($signed(rf_rd2_e)),
				.C(alu_c_e),
				.ALUOp(ctrl_aluop_e));
```

类似的还有`$display`,`$random`,`$time`等等，不能在接口处使用（即使符合verilog的规则）。

## 3. 其他建议

### 3-1. 编辑器的使用

由于ISE内置编辑器实在是给人一种过于古老的感觉，建议配合vscode打开项目编辑文件，配置好语法高亮和自动补全之后体验会很好，并且vscode修改保存之后回到ISE随便点一下就可以触发文件的刷新，也很方便。

### 3-2. 练习使用ISE

由于上机环境最稳定的其实就是ISE这个不太好使的工程软件，对于这种软件你确实可以嗤之以鼻，因为客观上来说这种工程软件都是"能跑就行"，对于用户体验是根本不管的。

但是你得上机，你就得熟练掌握ISE的各种操作，比如你得分清左侧下方的"语法检查"和"综合"的区别，有人用了`initial`块之后问我为什么ISE报错不给"仿真"，我一看好家伙，点的是"synthesize"，那当然不能"综合"，但是你做仿真就不需要管综合的事情，直接去testbench文件那里仿真就行。我觉得需要熟练掌握的操作有：

- 语法检测
- 导入你的cpu文件
- 搜索功能，便于debug
- 利用isim模拟，添加观测信号
- 右键点击执行错误的步骤其实可以rerun的

具体不再赘述，你可以百度得到结果。

## 后记

希望各位能够顺利通过P3/P4/P5以及之后的每个任务，如果你暂时卡关了，不要紧的，下次努力通过就行，别看的太重了。

> 一粒芝麻，凑近看会占据所有的视野；
>
> 偌大太阳，也不过是天上的一个火球。


</div>
<div class="reply-footer">
<abbr title="2024-11-08T09:16:12.825062+08:00"><time datetime="2024-11-08T09:16:12.825062+08:00">2024-11-08 09:16:12</time></abbr>
|
<span>CC BY-NC-SA 4.0</span>
<span class="reply-vote">❤️ 32</span>
</div>
</div>